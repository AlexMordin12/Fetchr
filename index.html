<html>
  <head>
    <link rel="stylesheet" href="microphone/microphone.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<style>

	.bottom{
		height: 20%
	}
	.jumbotron{
		height: 80%;
    	width: 100%;
    	
    	top: 50%;
    	left: 62%;
		background-color: gray;
		color: white;
	}
</style>
  </head>
  <body style="text-align: center;">
    
    <div class="jumbotron">
      <h1>Fetchr</h1>
      <p>A smarter way to ask for things</p>
      <center><div id="microphone"></div></center>
      <pre id="result"></pre>
      <div id="info"></div>
      <div id="error"></div>
      <div id="conversation"></div>
  </div>

  <div class="page-header">
  <h1>Siri in a browser<br><br> <small><div style="padding-left: 20%; padding-right: 20%">Fetchr is a dynamic input voice controlled search engine.<br> Utilizing wit.ai API to parse vocal inputs in to meaningful results<br>
  Asking for directions, Getting the weather, opening web pages, and answering questions are some of the Fetchr's features.</div></small></h1>
  </div>
  <div class="bottom">
    <div class="jumbotron">
      <p>Made at HackJam @ Berkeley</p>
  </div>
  </div>
    <script src="microphone/microphone.min.js"></script>

    <script>
      var mic = new Wit.Microphone(document.getElementById("microphone"));
      var info = function (msg) {
        document.getElementById("info").innerHTML = msg;
      };
      var error = function (msg) {
        document.getElementById("error").innerHTML = msg;
      };
      mic.onready = function () {
        info("Microphone is ready to record");
      };
      mic.onaudiostart = function () {
        info("Recording started");
        error("");
      };
      mic.onaudioend = function () {
        info("Recording stopped, processing started");
      };
      mic.onresult = function (intent, entities) {
        var r = kv("intent", intent);
        var intentVal = intent
        for (var k in entities) {
          var e = entities[k];

          if (!(e instanceof Array)) {
            r += kv(k, e.value);
          } else {
            for (var i = 0; i < e.length; i++) {
              r += kv(k, e[i].value);
            }
          }
        }

        //////////////////////////////////////////////////////////////////////////////////
        //Write switch case that parses the wit intent and use other apis to deal with it!-
        //////////////////////////////////////////////////////////////////////////////////
        
        switch(intentVal){
          case "weather":
            if(entities.weather_loc == undefined) {
              var action_url = "http://www.google.com/search?q=weather here";
            
            }
            else{
              var action_url = "http://www.google.com/search?q=weather in" + " " +entities.weather_loc.value; 
            
            }
            OpenInNewTab(action_url)
          break;

          case "music":
          
				var action_url = "http://www.youtube.com/results?search_query=" + entities.song.value;
				OpenInNewTab(action_url);
			
          	break;

		
		case "search":
				var search_site;
				if (entities.search_engine == undefined) {
					search_site = "";
				}
				else {
					search_site = search_engine.value;
				}
				switch(search_site) {
						case "wikipedia":
							var action_url = "http://en.wikipedia.org/w/index.php?search=" + entities.term_search.value;
							break;
						case "imdb":
							var action_url = "http://www.imdb.com/find?q=" + entities.term_search.value;
							break;
						case "wolfram":
							var action_url = "http://www.wolframalpha.com/input/?i=" + entities.term_search.value;
							break;
						default:
							var action_url = "http://www.google.com/search?q=" + entities.term_search.value;
							break;
					}
				OpenInNewTab(action_url);
		  break;

		  case 'newTab':
		  OpenInNewTab("http://www.google.com/");
		  break;

		  case "mail":
				if((entities.mail_address == undefined) || (entities.mail_recepient == undefined)) {
						document.getElementById("result").innerHTML += "Sorry, I didn't get that.";  
				}
				else{
						var action_url = "mailto:" + entities.mail_recepient.value+'@'+entities.mail_address.value;
						OpenInNewTab(action_url);
				}
			break;

		  case "direction":
				if (entities.direction_location == undefined) {
					var action_url = "http://maps.google.com/maps/?q=directions to" + " " + entities.direction_destination.value;
					OpenInNewTab(action_url);
				}
				else {
					var action_url = "http://maps.google.com/maps/?q=directions from" + " " + entities.direction_location.value + " to " + entities.direction_destination.value;
					OpenInNewTab(action_url);
				}
			break;

		  case "open":
				if((entities.open_website.value).indexOf(".") < 0) {
					var action_url = "http://" + entities.open_website.value.replace(/ /g,'') + ".com";
					OpenInNewTab(action_url)
				}
				else {
					var action_url = "http://" + entities.open_website.value.replace(/ /g,'');
					OpenInNewTab(action_url)
				}
			break;

          default:
        	document.getElementById("result").innerHTML = "I didn't get that";  
          break;

          document.getElementById("result").innerHTML = r;  
        }
        
        
        
      };


      mic.onerror = function (err) {
        error("Error: " + err);
      };
      mic.onconnecting = function () {
        info("Microphone is connecting");
      };
      mic.ondisconnected = function () {
        info("Microphone is not connected");
      };

      mic.connect("FFLAC5NG44F6R6TMWTOBXZADE7W5NLWZ");
      // mic.start();
      // mic.stop();

      



      function OpenInNewTab(url) {
        var win = window.open(url, '_blank');
        if(win){
          //Browser has allowed it to be opened
          win.focus();
        }else{
          //Broswer has blocked it
          alert('Please allow popups for this site');
        }
      }
      
      function kv (k, v) {
        if (toString.call(v) !== "[object String]") {
          v = JSON.stringify(v);
        }
        return k + "=" + v + "\n";
      }
    </script>
  </body>
  </html>